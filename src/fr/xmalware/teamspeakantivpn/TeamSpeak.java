package fr.xmalware.teamspeakantivpn;

import java.util.Random;

import com.github.theholywaffle.teamspeak3.TS3Api;
import com.github.theholywaffle.teamspeak3.TS3Config;
import com.github.theholywaffle.teamspeak3.TS3Query;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonObject;

import fr.xmalware.teamspeakantivpn.utils.ConfigUtils;
import fr.xmalware.teamspeakantivpn.utils.FileUtils;
import lombok.Data;

@Data
public class TeamSpeak
{

	private TS3Api					api				= null;
	private	Gson					gson;
	private	JsonObject				configuration	= new JsonObject();
	private String					apiKey			= null;
	private boolean					banIdentity		= false;
	private boolean					banIp			= false;
	private String					banReason		= null;

	public TeamSpeak()
	{
		setConfiguration(FileUtils.loadConfiguration());
		setGson(new GsonBuilder().setPrettyPrinting().create());
		Runtime.getRuntime().addShutdownHook(new Thread() {
		    public void run() {
		        getApi().logout();
		    }
		});
	}

	void load()
	{
		loadConfiguration();
	}

	void loadConfiguration()
	{
		try
		{
			final TS3Config config = new TS3Config();
			String hostname = ConfigUtils.get(getGson(), getConfiguration(), "hostname", "myServer").getAsString();
			int queryPort = ConfigUtils.get(getGson(), getConfiguration(), "queryPort", 10011).getAsInt();
			config.setHost(hostname);
			config.setQueryPort(queryPort);
			final TS3Query query = new TS3Query(config);
			query.connect();
			setApi(query.getApi());
			String username = ConfigUtils.get(getGson(), getConfiguration(), "queryUsername", "serveradmin").getAsString();
			String password = ConfigUtils.get(getGson(), getConfiguration(), "queryPassword", "changeIt").getAsString();
			int virtualServer = ConfigUtils.get(getGson(), getConfiguration(), "virtualServerId", 1).getAsInt();
			String nickname = ConfigUtils.get(getGson(), getConfiguration(), "nickname", "MyNickname").getAsString();
			getApi().login(username, password);
			getApi().selectVirtualServerById(virtualServer);
			String s = nickname.replace("%", Integer.toString(new Random().nextInt(Integer.MAX_VALUE)));
			getApi().setNickname(s);
			setApiKey(ConfigUtils.get(getGson(), getConfiguration(), "ipDetectorApiKey", "Set-Your-Api-Key").getAsString());
			setBanIdentity(ConfigUtils.get(getGson(), getConfiguration(), "banIdentity", false).getAsBoolean());
			setBanIp(ConfigUtils.get(getGson(), getConfiguration(), "banIp", true).getAsBoolean());
			setBanReason(ConfigUtils.get(getGson(), getConfiguration(), "banReason", "Set your ban reason").getAsString());
			VPNBlocker.checkEveryone();
			new TeamSpeakListener(this.getApi());
		}
		catch (Exception error)
		{
			System.out.println("Unable to connect to the TeamSpeak server: " + error.getMessage() + ".");
			System.exit(-1);
		}
	}

}
